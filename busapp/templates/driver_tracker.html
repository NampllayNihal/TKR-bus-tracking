{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Driver Live Tracking | TKRES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  

  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: "Poppins", sans-serif;
      position: relative;
      min-height: 100vh;
      color: #fff;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        linear-gradient(rgba(0,0,0,0.65), rgba(0,0,0,0.7)),
        url("{% static 'images/tkr_bus.png' %}") no-repeat center center fixed;
      background-size: cover;
      z-index: -1;
    }
    body.dark::before { background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.9)), url("{% static 'images/tkr_bus.png' %}"); }

    .page {
      position: relative;
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      width:100%;
    }

    h1 {
      font-size: 2.4rem;
      font-weight: 900;
      margin-top: 12px;
      margin-bottom: 4px;
      color: #ffd600;
      text-shadow: 0 3px 10px rgba(0,0,0,0.8);
      text-align:center;
    }

    .subtitle {
      font-size: 1rem;
      opacity:0.9;
      margin-bottom: 18px;
      text-align:center;
    }

    .card {
      width:100%;
      max-width:600px;
      background:rgba(0,0,0,0.6);
      border-radius:14px;
      padding:18px 20px;
      box-shadow:0 8px 20px rgba(0,0,0,0.4);
      backdrop-filter:blur(8px);
    }

    label { display:block; font-size:0.95rem; margin-bottom:4px; opacity:0.9; }
    select, input {
      width:100%;
      padding:10px;
      border-radius:8px;
      border:none;
      margin-bottom:12px;
      font-size:0.95rem;
    }

    .btn-row { display:flex; gap:10px; margin-top:8px; }

    .btn {
      flex:1; padding:10px 0; border-radius:999px; border:none; font-weight:700;
      cursor:pointer; font-size:1rem;
    }
    .btn-start { background:#00c853; color:#000; }
    .btn-stop  { background:#ff5252; color:#fff; }

    .btn-start:hover { background:#00e676; }
    .btn-stop:hover  { background:#ff1744; }

    .status { margin-top:12px; font-size:0.95rem; }
    .status span.label { opacity:0.85; }

    .back-btn {
      margin-top:24px;
      text-decoration:none;
      color:#000;
      background:#ffd600;
      padding:10px 22px;
      border-radius:999px;
      font-weight:700;
      font-size:0.95rem;
    }
  </style>
</head>
<body>

<div class="page">
  <h1>Driver Live Tracking</h1>
  <div class="subtitle">
    Select your bus and press <strong>Start</strong>. Students will see your live location on the map. üöå
  </div>

  <div class="card">
    <div style="margin-bottom: 12px;">
      <strong>Driver:</strong> <span id="driverName">{{ user.get_full_name|default:user.username }}</span><br>
      <strong>Assigned Route:</strong> <span id="assignedRoute">{{ driver.assigned_route.name|default:"No route assigned" }}</span>
    </div>

    <div class="btn-row">
      <button class="btn btn-start" onclick="startTracking()" id="startBtn">‚ñ∂ Start Tracking</button>
      <button class="btn btn-stop" onclick="stopTracking()" id="stopBtn" disabled>‚ñ† Stop Tracking</button>
    </div>

    <div class="status">
      <div><span class="label">Tracking Status:</span> <span id="statusText">Not started</span></div>
      <div><span class="label">Current Location:</span> <span id="locText">‚Äì</span></div>
      <div><span class="label">Last Updated:</span> <span id="timeText">‚Äì</span></div>
    </div>
  </div>

  <!-- ‚úÖ FIXED URL NAME -->
  <a href="{% url 'logout' %}" class="back-btn">‚¨Ö Logout</a>

</div>

<script>
  // BLOCK PAGE IF STUDENT
 

  function logout() {
    localStorage.clear();
  }
</script>

<!-- FIREBASE SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

<script>

  // TODO: Add your real Firebase credentials later
  const firebaseConfig = {
    apiKey: "AIzaSyB1RjGjAZ74fwhWwxTu7GxPIZvJKUsHBys",
    authDomain: "tkres-bus-tracking.firebaseapp.com",
    databaseURL: "https://tkres-bus-tracking-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tkres-bus-tracking",
    storageBucket: "tkres-bus-tracking.firebasestorage.app",
    messagingSenderId: "284217789696",
    appId: "1:284217789696:web:44fdafc5f67dd78f4777e5"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  
let watchId = null;
let currentBusNumber = null;
let driverName = null;
let dataUpdateInterval = null;

document.addEventListener('DOMContentLoaded', function() {
  // Get bus_number from Django context
  currentBusNumber = "{{ bus_number }}";
  console.log("Raw bus_number from template:", "{{ bus_number }}");
  
  if (!currentBusNumber || currentBusNumber === "None" || currentBusNumber === "") {
    console.error("‚ùå Bus number not set! This will cause Firebase errors.");
    currentBusNumber = null;
  }
  
  // Get driver name
  const driverNameEl = document.getElementById('driverName');
  driverName = driverNameEl.textContent.trim();
  
  if (currentBusNumber) {
    console.log("‚úÖ Driver loaded. Bus Number:", currentBusNumber, "| Driver:", driverName);
  } else {
    console.error("‚ùå ERROR: Bus number is null. Driver won't be able to broadcast location!");
  }
});

function startTracking() {
  if (!currentBusNumber) {
    alert("‚ùå No bus number assigned to you. Please contact admin.");
    return;
  }

  document.getElementById("statusText").innerText = "üî¥ Starting GPS tracking...";
  document.getElementById("startBtn").disabled = true;
  document.getElementById("stopBtn").disabled = false;

  // First location update
  var errorCount = 0;

  watchId = navigator.geolocation.watchPosition(
    position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const accuracy = position.coords.accuracy;
      const timestamp = Date.now();

      const busData = {
        busId: currentBusNumber,
        route: currentBusNumber,  // or keep as is
        driver: driverName,
        lat: lat,
        lng: lng,
        timestamp: timestamp,
        accuracy: accuracy
      };

      if (!currentBusNumber) {
        console.error("‚ùå Cannot update Firebase: currentBusNumber is null!");
        document.getElementById("statusText").innerText = "‚ùå Bus number not set - contact admin";
        return;
      }

      console.log("üìç Updating Firebase at path: buses/" + currentBusNumber, "Data:", busData);

      db.ref("buses/" + currentBusNumber).set(busData)
        .then(() => {
          console.log("‚úÖ Firebase update successful for", currentBusNumber);
          document.getElementById("statusText").innerText = "üü¢ Tracking Active - Broadcasting to students";
          document.getElementById("locText").innerText = 
            lat.toFixed(5) + ", " + lng.toFixed(5);
          document.getElementById("timeText").innerText = 
            new Date().toLocaleTimeString();
        })
        .catch(error => {
          console.error("‚ùå Firebase write error:", error.message);
          console.error("Firebase error code:", error.code);
          console.error("Full error:", error);
          document.getElementById("statusText").innerText = "‚ö†Ô∏è Firebase error: " + error.message;
        });
    },
    error => {
      errorCount++;
      console.error("‚ùå GPS Error:", error.message);
      
      let errorMsg = "GPS Error";
      if (error.code === error.PERMISSION_DENIED) {
        errorMsg = "GPS permission denied - enable location";
      } else if (error.code === error.POSITION_UNAVAILABLE) {
        errorMsg = "Location unavailable";
      } else if (error.code === error.TIMEOUT) {
        errorMsg = "GPS timeout - enable location services";
      }
      
      document.getElementById("statusText").innerText = "‚ö†Ô∏è " + errorMsg;
      
      if (errorCount > 3) {
        stopTracking();
        alert("Failed to get GPS location. Please enable GPS and try again.");
      }
    },
    {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 10000
    }
  );
}

function stopTracking() {
  if (watchId) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    
    // Remove from Firebase
    if (currentBusNumber) {
      console.log("üõë Removing from Firebase:", currentBusNumber);
      db.ref("buses/" + currentBusNumber).remove();
    }
    
    document.getElementById("statusText").innerText = "‚èπÔ∏è Tracking Stopped";
    document.getElementById("startBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;
    document.getElementById("locText").innerText = "‚Äì";
    document.getElementById("timeText").innerText = "‚Äì";
  }
}
</script>

</body>
</html>
