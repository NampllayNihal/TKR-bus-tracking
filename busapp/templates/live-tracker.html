{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Bus Tracker | TKRES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  

  <style>
    body {
      margin: 0;
      padding: 18px;
      font-family: "Poppins", sans-serif;
      position: relative;
      color: #fff;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.7)),
        url("{% static 'images/tkr_bus.png' %}") no-repeat center center fixed;
      background-size: cover;
      z-index: -1;
    }

    #map {
      width:100%;
      max-width:1100px;
      height:70vh;
      margin:0 auto;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 8px 22px rgba(0,0,0,0.5);
    }

    .back-btn {
      display:block;
      width:max-content;
      margin:18px auto 8px;
      text-decoration:none;
      color:#000;
      background:#ffd600;
      padding:10px 22px;
      border-radius:999px;
      font-weight:700;
      font-size:0.98rem;
      transition:0.3s;
    }
    .back-btn:hover {
      background:#ffeb3b;
    }

    .bus-marker {
      background: none;
      border: none;
    }
  </style>
</head>
<body>

<div class="page">

  <h1 style="text-align:center;color:#ffd600;">Live Bus Tracker</h1>
  <div style="text-align:center;font-size:1.05rem;margin-bottom:16px;opacity:0.9;">
    View live locations of college buses. Select your route to highlight your bus. üöå
  </div>

  <div class="top-controls">
    <div style="display:flex;gap:8px;">
      <label for="routeFilter">Filter by Route:</label>
      <select id="routeFilter">
        <option value="all">All Routes</option>
        {% for route in routes %}
        <option value="{{ route.bus_number }}" {% if student_route and student_route.id == route.id %}selected{% endif %}>{{ route.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div id="lastUpdated" style="font-size:0.9rem;background:rgba(0,0,0,0.6);padding:6px 10px;border-radius:999px;">
      Last update: ‚Äì
    </div>
  </div>

  <div id="map"></div>

  <!-- ‚úÖ FIXED -->
  <a href="{% url 'student_index' %}" class="back-btn">‚¨Ö Back to Home</a>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

<script>
  const theme = localStorage.getItem("tkres-theme");
  if (theme === "dark") document.body.classList.add("dark");

  const firebaseConfig = {
    apiKey: "AIzaSyB1RjGjAZ74fwhWwxTu7GxPIZvJKUsHBys",
    authDomain: "tkres-bus-tracking.firebaseapp.com",
    databaseURL: "https://tkres-bus-tracking-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tkres-bus-tracking",
    storageBucket: "tkres-bus-tracking.firebasestorage.app",
    messagingSenderId: "284217789696",
    appId: "1:284217789696:web:44fdafc5f67dd78f4777e5"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  console.log("‚úÖ Firebase initialized successfully");

  // Check Firebase connection
  db.ref('.info/connected').on('value', snap => {
    if (snap.val() === true) {
      console.log("‚úÖ Connected to Firebase Realtime Database");
    } else {
      console.log("‚ùå Disconnected from Firebase Realtime Database");
      lastUpdatedEl.textContent = "‚ö†Ô∏è Database connection lost";
    }
  });

  const map = L.map('map').setView([17.3850, 78.4867], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  const routeFilter = document.getElementById("routeFilter");
  const lastUpdatedEl = document.getElementById("lastUpdated");

  let busMarker = null;
  let activeListener = null;

  const busIcon = L.divIcon({
    className: "bus-marker",
    html: `<div style="font-size:26px;text-shadow:0 0 4px #000;">üöå</div>`
  });

  function clearMarker() {
    if (busMarker) {
      map.removeLayer(busMarker);
      busMarker = null;
    }
  }

  function listenToRoute(routeVal) {
    if (activeListener) {
      activeListener.off();
      activeListener = null;
    }

    clearMarker();

    if (routeVal === "all") {
      lastUpdatedEl.textContent = "Select a route to track";
      return;
    }

    // Convert route value to bus ID format
    // routeVal is now the bus_number (e.g., "BUS001")
    const busId = routeVal;

    if (!busId || busId === "all" || busId === "") {
      console.error("‚ùå Invalid route/bus selection:", routeVal);
      lastUpdatedEl.textContent = "‚ùå Invalid route selected";
      return;
    }

    console.log("üëÄ Student listening to route:", routeVal, "-> Firebase path: buses/" + busId);

    activeListener = db.ref("buses/" + busId);

    activeListener.on("value", snapshot => {
      const b = snapshot.val();

      console.log("üì® Received data from Firebase for", busId, ":", b);

      if (!b || b === null) {
        console.log("‚ö†Ô∏è No data for bus", busId, "- driver hasn't started tracking yet");
        lastUpdatedEl.textContent = "üî¥ Waiting for driver to start tracking...";
        clearMarker();
        return;
      }

      if (!b.lat || !b.lng) {
        console.log("‚ö†Ô∏è Bus data missing lat/lng:", b);
        lastUpdatedEl.textContent = "üöê Bus location not available";
        clearMarker();
        return;
      }

      const lat = parseFloat(b.lat);
      const lng = parseFloat(b.lng);
      if (isNaN(lat) || isNaN(lng)) {
        console.log("‚ö†Ô∏è Invalid lat/lng values:", b.lat, b.lng);
        lastUpdatedEl.textContent = "üöê Invalid location data";
        clearMarker();
        return;
      }

      const latLng = [lat, lng];

      console.log("üìç Valid bus location:", latLng);

      if (!busMarker) {
        busMarker = L.marker(latLng, { icon: busIcon }).addTo(map);
        console.log("‚úÖ Bus marker created at", latLng);
      } else {
        busMarker.setLatLng(latLng);
        console.log("‚úÖ Bus marker updated to", latLng);
      }

      busMarker.bindPopup(`
        <div style="font-family: Poppins; text-align: center;">
          <strong style="font-size: 1.1em;">üöå ${b.busId || busId}</strong><br>
          <hr style="margin: 5px 0;">
          Route: ${b.route || routeVal}<br>
          Driver: ${b.driver || "N/A"}<br>
          Accuracy: ${Math.round(b.accuracy || 0)}m<br>
          <small>Last update: ${new Date(b.timestamp || Date.now()).toLocaleTimeString()}</small>
        </div>
      `);

      map.setView(latLng, 14);
      lastUpdatedEl.textContent = "üü¢ Last update: " + new Date().toLocaleTimeString();
      console.log("‚úÖ Map updated and centered on bus");
    });

    activeListener.on("error", error => {
      console.error("‚ùå Firebase listener error for", busId, ":", error);
      lastUpdatedEl.textContent = "‚ö†Ô∏è Connection error: " + error.message;
      clearMarker();
    });
  }

  routeFilter.addEventListener("change", () => {
    const selectedRoute = routeFilter.value;
    console.log("üîÑ Route filter changed to:", selectedRoute);
    listenToRoute(selectedRoute);
  });

  // Auto-start listening if a route is pre-selected
  document.addEventListener('DOMContentLoaded', function() {
    const selectedValue = routeFilter.value;
    console.log("üì° Page loaded. Pre-selected route:", selectedValue);
    if (selectedValue && selectedValue !== "all") {
      listenToRoute(selectedValue);
    }
  });

  // Also check on page load
  window.addEventListener('load', function() {
    const selectedValue = routeFilter.value;
    console.log("‚úÖ Window loaded. Checking pre-selected route:", selectedValue);
    if (selectedValue && selectedValue !== "all") {
      // Give Firebase time to initialize
      setTimeout(() => {
        listenToRoute(selectedValue);
      }, 500);
    }
  });
</script>


</body>
</html>
