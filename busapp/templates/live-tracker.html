{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Bus Tracker | TKRES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body {
      margin: 0;
      padding: 18px;
      font-family: "Poppins", sans-serif;
      position: relative;
      color: #fff;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.7)),
        url("{% static 'images/tkr_bus.png' %}") no-repeat center center fixed;
      background-size: cover;
      z-index: -1;
    }

    #map {
      width:100%;
      max-width:1100px;
      height:70vh;
      margin:0 auto;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 8px 22px rgba(0,0,0,0.5);
    }

    .back-btn {
      display:block;
      width:max-content;
      margin:18px auto 8px;
      text-decoration:none;
      color:#000;
      background:#ffd600;
      padding:10px 22px;
      border-radius:999px;
      font-weight:700;
      font-size:0.98rem;
      transition:0.3s;
    }
    .back-btn:hover {
      background:#ffeb3b;
    }
  </style>
</head>
<body>

<div class="page">

  <h1 style="text-align:center;color:#ffd600;">Live Bus Tracker</h1>
  <div style="text-align:center;font-size:1.05rem;margin-bottom:16px;opacity:0.9;">
    View live locations of college buses. Select your route to highlight your bus. ðŸšŒ
  </div>

  <div class="top-controls">
    <div style="display:flex;gap:8px;">
      <label for="routeFilter">Filter by Route:</label>
      <select id="routeFilter">
        <option value="all">All Routes</option>
        <option value="1">Route 1 â€“ Narapally</option>
        <option value="2">Route 2 â€“ Mehdipatnam</option>
        <option value="3">Route 3 â€“ Malkajgiri</option>
        <option value="4">Route 4 â€“ Hayath Nagar</option>
        <option value="5">Route 5 â€“ Alwal</option>
        <option value="6">Route 6 â€“ Musheerabad</option>
        <option value="7">Route 7 â€“ ECIL</option>
        <option value="8">Route 8 â€“ Chandrayangutta</option>
        <option value="9">Route 9 â€“ Kukatpally</option>
      </select>
    </div>

    <div id="lastUpdated" style="font-size:0.9rem;background:rgba(0,0,0,0.6);padding:6px 10px;border-radius:999px;">
      Last update: â€“
    </div>
  </div>

  <div id="map"></div>

  <!-- âœ… FIXED -->
  <a href="{% url 'student_index' %}" class="back-btn">â¬… Back to Home</a>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

<script>
 

  const theme = localStorage.getItem("tkres-theme");
  if (theme === "dark") document.body.classList.add("dark");

  const firebaseConfig = {
    apiKey: "AIzaSyB1RjGjAZ74fwhWwxTu7GxPIZvJKUsHBys",
    authDomain: "tkres-bus-tracking.firebaseapp.com",
    databaseURL: "https://tkres-bus-tracking-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "tkres-bus-tracking",
    storageBucket: "tkres-bus-tracking.firebasestorage.app",
    messagingSenderId: "284217789696",
    appId: "1:284217789696:web:44fdafc5f67dd78f4777e5"
  };


  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const map = L.map('map').setView([17.3850, 78.4867], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom: 19 }).addTo(map);

  const routeFilter = document.getElementById("routeFilter");
  const lastUpdatedEl = document.getElementById("lastUpdated");

  const busMarkers = {};

  const busIcon = () => L.divIcon({
    className: "bus-marker",
    html: `<div style="font-size:26px;text-shadow:0 0 4px #000;">ðŸšŒ</div>`
  });

  function renderPopup(b) {
    const timeStr = b.timestamp ? new Date(b.timestamp).toLocaleTimeString() : "â€“";
    return `
      <strong>${b.busId}</strong><br>
      Route: ${b.route || "-"}<br>
      Driver: ${b.driver || "-"}<br>
      Last update: ${timeStr}
    `;
  }

  function updateBusMarkers(busesData) {
    const filterVal = routeFilter.value;

    Object.keys(busesData || {}).forEach(busId => {
      const b = busesData[busId];
      if (!b || !b.lat || !b.lng) return;

      const showThis =
        filterVal === "all" || String(b.route) === String(filterVal);

      if (!busMarkers[busId]) {
        const marker = L.marker([b.lat, b.lng], { icon: busIcon() })
          .bindPopup(renderPopup(b));
        busMarkers[busId] = marker;
      }

      busMarkers[busId].setLatLng([b.lat, b.lng]);
      busMarkers[busId].setPopupContent(renderPopup(b));

      if (showThis) {
        if (!map.hasLayer(busMarkers[busId])) {
          busMarkers[busId].addTo(map);
        }
      } else {
        if (map.hasLayer(busMarkers[busId])) {
          map.removeLayer(busMarkers[busId]);
        }
      }
    });

    const now = new Date();
    lastUpdatedEl.textContent = "Last update: " + now.toLocaleTimeString();
  }

  db.ref("buses").on("value", snapshot => {
  updateBusMarkers(snapshot.val());
});

</script>

</body>
</html>
